<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Payment Receipt - First Class Senior High School</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
<style>
*{box-sizing:border-box;}
body{font-family:"Arial",sans-serif;background:linear-gradient(135deg,#004b23,#006400);margin:0;padding:0;min-height:100vh;display:flex;justify-content:center;align-items:center;overflow-x:hidden;}
.container{width:90%;max-width:600px;padding:25px 30px;border-radius:15px;backdrop-filter:blur(15px);background:rgba(255,255,255,0.15);border:1px solid rgba(255,215,0,0.6);box-shadow:0 0 25px rgba(255,215,0,0.3);text-align:center;color:#fff;opacity:0;transform:translateY(40px);animation:fadeUp 1.2s ease-out forwards,goldPulse 5s infinite ease-in-out;}
@keyframes fadeUp{from{opacity:0;transform:translateY(40px);}to{opacity:1;transform:translateY(0);}}
@keyframes goldPulse{0%{box-shadow:0 0 20px rgba(255,215,0,0.2),0 0 40px rgba(255,215,0,0.15);}50%{box-shadow:0 0 30px rgba(255,215,0,0.5),0 0 60px rgba(255,215,0,0.4);}100%{box-shadow:0 0 20px rgba(255,215,0,0.2),0 0 40px rgba(255,215,0,0.15);}}
.logo{max-width:100px;margin:0 auto 10px;display:block;border-radius:50%;}
.school-name{font-size:22px;font-weight:bold;color:#ffd700;margin-bottom:5px;}
.subtitle{font-size:14px;color:#f1f1f1;}
hr{border:none;height:2px;background:#ffd700;margin:15px 0;}
.form-group{margin-bottom:15px;text-align:left;}
label{font-weight:bold;color:#fff;display:block;margin-bottom:5px;}
input,select,textarea{width:100%;padding:10px;border:1px solid rgba(255,255,255,0.3);border-radius:6px;font-size:14px;background:rgba(255,255,255,0.1);color:#fff;outline:none;}
input:focus,select:focus{border-color:#ffd700;box-shadow:0 0 6px rgba(255,215,0,0.5);}
option{color:#000;}
.amount-words{color:#fffae6;font-style:italic;font-size:13px;margin-top:3px;}
.buttons{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-top:20px;}
button{flex:1 1 45%;background:#ffd700;color:#004b23;border:none;border-radius:8px;padding:10px;cursor:pointer;transition:all 0.3s ease;font-weight:bold;font-size:14px;}
button:hover{background:#ffeb66;}
small{color:#f0f0f0;font-size:12px;}
.admin-container{width:95%;max-width:1200px;padding:20px;border-radius:15px;backdrop-filter:blur(15px);background:rgba(255,255,255,0.15);border:1px solid rgba(255,215,0,0.6);box-shadow:0 0 25px rgba(255,215,0,0.3);color:#fff;opacity:0;transform:translateY(40px);animation:fadeUp 1.2s ease-out forwards;}
.admin-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.admin-title{font-size:24px;font-weight:bold;color:#ffd700;}
.admin-controls{display:flex;gap:10px;margin-bottom:20px;}
.admin-controls input,.admin-controls select{flex:1;background:rgba(255,255,255,0.2);color:#fff;}
.receipts-table{width:100%;border-collapse:collapse;margin-top:20px;}
.receipts-table th,.receipts-table td{padding:12px 15px;text-align:left;border-bottom:1px solid rgba(255,255,255,0.2);}
.receipts-table th{background-color:rgba(255,215,0,0.3);color:#ffd700;}
.receipts-table tr:hover{background-color:rgba(255,255,255,0.1);}
.action-btn{padding:6px 12px;margin:0 5px;border:none;border-radius:4px;cursor:pointer;font-size:12px;}
.view-btn{background:#4CAF50;color:white;}
.delete-btn{background:#f44336;color:white;}
.pagination{display:flex;justify-content:center;margin-top:20px;gap:10px;}
.pagination button{padding:8px 12px;background:rgba(255,215,0,0.5);color:#004b23;border:none;border-radius:4px;cursor:pointer;}
.pagination button:disabled{background:rgba(255,255,255,0.2);color:rgba(255,255,255,0.5);cursor:not-allowed;}
.nav-buttons{display:flex;justify-content:center;gap:10px;margin-top:20px;}
.nav-btn{padding:10px 20px;background:rgba(255,215,0,0.7);color:#004b23;border:none;border-radius:8px;cursor:pointer;font-weight:bold;}
.auth-container{width:90%;max-width:400px;padding:25px 30px;border-radius:15px;backdrop-filter:blur(15px);background:rgba(255,255,255,0.15);border:1px solid rgba(255,215,0,0.6);box-shadow:0 0 25px rgba(255,215,0,0.3);text-align:center;color:#fff;}
.auth-container input{margin-bottom:15px;}
.auth-btn{width:100%;padding:12px;background:#ffd700;color:#004b23;border:none;border-radius:8px;cursor:pointer;font-weight:bold;margin-top:10px;}
.hidden{display:none;}
@media(max-width:768px){.admin-controls{flex-direction:column;}.receipts-table{font-size:12px;}.receipts-table th,.receipts-table td{padding:8px 10px;}}
@media(max-width:480px){button{flex:1 1 100%;}.school-name{font-size:18px;}.admin-header{flex-direction:column;gap:10px;}}
</style>
</head>
<body>
<div id="loginContainer" class="auth-container">
<h2>Admin Login</h2>
<input type="email" id="adminEmail" placeholder="Admin Email"/>
<input type="password" id="adminPassword" placeholder="Password"/>
<button id="loginBtn" class="auth-btn">Login</button>
<p>Not an admin? <a href="#" id="goToReceiptBtn">Go to Receipt Generator</a></p>
</div>
<div id="receiptContainer" class="container hidden">
<div class="header">
<img src="./fci logo 1.png" alt="School Logo" class="logo"/>
<div class="school-name">First Class Senior High School</div>
<div class="subtitle">Academic Year: 2025/2026</div>
<div class="subtitle">Contact: 0244406506 / 0245319301 / 0243686024 / 0242842244</div>
<div class="subtitle">Website: www.firstclassschools.org</div>
<div class="subtitle">Email: info@firstclassschools.org</div>
<hr/>
</div>
<div class="content">
<div class="form-group"><label for="receiptNumber">Receipt Number:</label><input type="text" id="receiptNumber" readonly/></div>
<div class="form-group">
<label for="campus">Branch Name:</label>
<select id="campus">
<option value="">-- Select Branch --</option>
<option>Afra Odumase</option><option>Daban</option><option>Edwenase</option>
<option>Takoradi</option><option>Accra</option><option>Tamale</option>
</select>
</div>
<div class="form-group"><label for="studentName">Name:</label><input type="text" id="studentName"/></div>
<div class="form-group">
<label for="class">Program:</label>
<select id="class">
<option value="">-- Select Program --</option>
<option>General Arts</option><option>General Science</option><option>Agric Science</option>
<option>Business</option><option>Home Economics</option><option>Visual Arts</option>
</select>
</div>
<div class="form-group"><label for="paymentMethod">Payment Method:</label><input type="text" id="paymentMethod"/></div>
<div class="form-group"><label for="totalAmount">Total Amount (GHS):</label><input type="number" id="totalAmount" oninput="calculateArrears()"/></div>
<div class="form-group">
<label for="amountPaid">Amount Paid (GHS):</label>
<input type="number" id="amountPaid" oninput="calculateArrears(); updateAmountInWords();"/>
<p id="amountInWords" class="amount-words"></p>
</div>
<div class="form-group">
<label for="purposeOfPayment">Purpose of Payment:</label>
<select id="purposeOfPayment" multiple size="8">
<option>Admission Fee</option><option>Registration Fee</option><option>Tuition Fee</option>
<option>Hostel Fee</option><option>PTA Dues</option><option>Books & Stationery</option>
<option>Uniform & Sportswear</option><option>Feeding Fee</option><option>Extra Classes</option>
<option>NOV/DEC Classes Fee</option><option>Center Fee</option>
</select>
<small>Hold Ctrl (Windows) or Command (Mac) to select multiple items.</small>
</div>
<div class="form-group"><label for="arrears">Arrears (GHS):</label><input type="text" id="arrears" readonly/></div>
<div class="form-group"><label for="receivedBy">Received By:</label><input type="text" id="receivedBy"/></div>
<div class="form-group"><label for="date">Date:</label><input type="date" id="date"/></div>
<div class="buttons">
<button id="previewBtn">Preview PDF</button>
<button id="generateReceiptBtn">Generate Receipt</button>
<button id="goToAdminBtn" class="nav-btn">Admin Dashboard</button>
</div>
</div>
<div id="receiptOutput" class="footer"></div>
</div>
<div id="adminContainer" class="admin-container hidden">
<div class="admin-header">
<div class="admin-title">Receipt Management Dashboard</div>
<div>
<button id="logoutBtn" class="nav-btn">Logout</button>
<button id="goToReceiptFromAdminBtn" class="nav-btn">Receipt Generator</button>
</div>
</div>
<div class="admin-controls">
<input type="text" id="searchInput" placeholder="Search by name, receipt number, or branch..."/>
<select id="filterBranch">
<option value="">All Branches</option>
<option>Afra Odumase</option><option>Daban</option><option>Edwenase</option>
<option>Takoradi</option><option>Accra</option><option>Tamale</option>
</select>
<input type="date" id="filterDateFrom"/>
<input type="date" id="filterDateTo"/>
<button id="applyFiltersBtn" class="nav-btn">Apply Filters</button>
<button id="clearFiltersBtn" class="nav-btn">Clear Filters</button>
</div>
<div id="receiptsList">
<table class="receipts-table">
<thead>
<tr>
<th>Receipt No.</th>
<th>Student Name</th>
<th>Branch</th>
<th>Program</th>
<th>Amount Paid</th>
<th>Date</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="receiptsTableBody">
</tbody>
</table>
</div>
<div class="pagination">
<button id="prevPageBtn">&laquo; Previous</button>
<span id="pageInfo">Page 1 of 1</span>
<button id="nextPageBtn">Next &raquo;</button>
</div>
</div>

<script>
const firebaseConfig={apiKey:"AIzaSyBkofsFfG3XxbXUyFWVodvZ1i074YpTxkY",authDomain:"fci-receipt-system.firebaseapp.com",projectId:"fci-receipt-system",storageBucket:"fci-receipt-system.firebasestorage.app",messagingSenderId:"878350453454",appId:"1:878350453454:web:23b4815a32076880ab9e9f"};
firebase.initializeApp(firebaseConfig);
const db=firebase.firestore();
const auth=firebase.auth();
(function(){try{emailjs.init("9jzpvsBEPgSrM5VaS");}catch(e){console.warn(e);}})();
const loginContainer=document.getElementById('loginContainer');
const receiptContainer=document.getElementById('receiptContainer');
const adminContainer=document.getElementById('adminContainer');
const loginBtn=document.getElementById('loginBtn');
const goToReceiptBtn=document.getElementById('goToReceiptBtn');
const goToAdminBtn=document.getElementById('goToAdminBtn');
const goToReceiptFromAdminBtn=document.getElementById('goToReceiptFromAdminBtn');
const logoutBtn=document.getElementById('logoutBtn');
const receiptsTableBody=document.getElementById('receiptsTableBody');
const searchInput=document.getElementById('searchInput');
const filterBranch=document.getElementById('filterBranch');
const filterDateFrom=document.getElementById('filterDateFrom');
const filterDateTo=document.getElementById('filterDateTo');
const applyFiltersBtn=document.getElementById('applyFiltersBtn');
const clearFiltersBtn=document.getElementById('clearFiltersBtn');
const prevPageBtn=document.getElementById('prevPageBtn');
const nextPageBtn=document.getElementById('nextPageBtn');
const pageInfo=document.getElementById('pageInfo');
const generateReceiptBtn=document.getElementById('generateReceiptBtn');
const previewBtn=document.getElementById('previewBtn');
document.getElementById('date').valueAsDate=new Date();
let currentPage=1;
const receiptsPerPage=10;
let totalReceipts=0;
let filteredReceipts=[];
let currentFilters={};
function showLogin(){loginContainer.classList.remove('hidden');receiptContainer.classList.add('hidden');adminContainer.classList.add('hidden');}
function showReceiptGenerator(){loginContainer.classList.add('hidden');receiptContainer.classList.remove('hidden');adminContainer.classList.add('hidden');generateReceiptNumber();}
function showAdminDashboard(){loginContainer.classList.add('hidden');receiptContainer.classList.add('hidden');adminContainer.classList.remove('hidden');loadReceipts();}
goToReceiptBtn.addEventListener('click',showReceiptGenerator);
goToAdminBtn.addEventListener('click',showAdminDashboard);
goToReceiptFromAdminBtn.addEventListener('click',showReceiptGenerator);
loginBtn.addEventListener('click',async()=>{const email=document.getElementById('adminEmail').value;const password=document.getElementById('adminPassword').value;try{await auth.signInWithEmailAndPassword(email,password);showAdminDashboard();}catch(error){alert('Login failed: '+error.message);}});
logoutBtn.addEventListener('click',async()=>{try{await auth.signOut();showLogin();}catch(error){console.error('Logout error:',error);}});
auth.onAuthStateChanged(user=>{if(user){}else{showLogin();}});
function generateReceiptNumber(){document.getElementById("receiptNumber").value="REC"+Date.now();}
function calculateArrears(){const total=parseFloat(document.getElementById("totalAmount").value)||0;const paid=parseFloat(document.getElementById("amountPaid").value)||0;document.getElementById("arrears").value=(total-paid>=0?(total-paid).toFixed(2):"0.00");}
function numberToWords(num){const ones=["","One","Two","Three","Four","Five","Six","Seven","Eight","Nine"];const teens=["Ten","Eleven","Twelve","Thirteen","Fourteen","Fifteen","Sixteen","Seventeen","Eighteen","Nineteen"];const tens=["","","Twenty","Thirty","Forty","Fifty","Sixty","Seventy","Eighty","Ninety"];function convert_hundreds(n){if(n<10)return ones[n];if(n<20)return teens[n-10];if(n<100)return tens[Math.floor(n/10)]+(n%10?" "+ones[n%10]:"");return ones[Math.floor(n/100)]+" Hundred "+(n%100?convert_hundreds(n%100):"");}if(num===0)return"Zero";if(num>999999)return"Amount too large";let words="";if(Math.floor(num/1000)>0){words+=convert_hundreds(Math.floor(num/1000))+" Thousand ";num%=1000;}words+=convert_hundreds(num);return words.trim();}
function updateAmountInWords(){const amount=parseFloat(document.getElementById("amountPaid").value)||0;const cedis=Math.floor(amount);const pesewas=Math.round((amount-cedis)*100);let words=numberToWords(cedis)+" Ghana Cedis";if(pesewas>0)words+=" and "+numberToWords(pesewas)+" Pesewas";document.getElementById("amountInWords").innerText=words;}
async function saveReceiptToFirebase(receiptData){try{await db.collection('receipts').add({...receiptData,timestamp:firebase.firestore.FieldValue.serverTimestamp()});return true;}catch(error){console.error('Error saving receipt:',error);return false;}}
async function loadReceipts(filters={},page=1){try{let query=db.collection('receipts').orderBy('timestamp','desc');if(filters.search){query=query.where('studentName','>=',filters.search).where('studentName','<=',filters.search+'\uf8ff');}if(filters.branch){query=query.where('campus','==',filters.branch);}if(filters.dateFrom||filters.dateTo){}const snapshot=await query.get();totalReceipts=snapshot.size;filteredReceipts=[];snapshot.forEach(doc=>{filteredReceipts.push({id:doc.id,...doc.data()});});displayReceipts(page);}catch(error){console.error('Error loading receipts:',error);}}
function displayReceipts(page){const startIndex=(page-1)*receiptsPerPage;const endIndex=startIndex+receiptsPerPage;const pageReceipts=filteredReceipts.slice(startIndex,endIndex);receiptsTableBody.innerHTML='';if(pageReceipts.length===0){receiptsTableBody.innerHTML='<tr><td colspan="7" style="text-align: center;">No receipts found</td></tr>';return;}pageReceipts.forEach(receipt=>{const row=document.createElement('tr');row.innerHTML=`<td>${receipt.receiptNumber||'N/A'}</td><td>${receipt.studentName||'N/A'}</td><td>${receipt.campus||'N/A'}</td><td>${receipt.program||'N/A'}</td><td>GHS ${receipt.amountPaid||'0.00'}</td><td>${receipt.date||'N/A'}</td><td><button class="action-btn view-btn" data-id="${receipt.id}">View</button><button class="action-btn delete-btn" data-id="${receipt.id}">Delete</button></td>`;receiptsTableBody.appendChild(row);});const totalPages=Math.ceil(filteredReceipts.length/receiptsPerPage);pageInfo.textContent=`Page ${page} of ${totalPages}`;prevPageBtn.disabled=page<=1;nextPageBtn.disabled=page>=totalPages;document.querySelectorAll('.view-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{const receiptId=e.target.getAttribute('data-id');viewReceipt(receiptId);});});document.querySelectorAll('.delete-btn').forEach(btn=>{btn.addEventListener('click',(e)=>{const receiptId=e.target.getAttribute('data-id');deleteReceipt(receiptId);});});}
async function viewReceipt(receiptId){try{const doc=await db.collection('receipts').doc(receiptId).get();if(doc.exists){const receipt=doc.data();openReceiptWindow(receipt);}}catch(error){console.error('Error viewing receipt:',error);}}
async function deleteReceipt(receiptId){if(confirm('Are you sure you want to delete this receipt?')){try{await db.collection('receipts').doc(receiptId).delete();loadReceipts(currentFilters,currentPage);alert('Receipt deleted successfully');}catch(error){console.error('Error deleting receipt:',error);alert('Failed to delete receipt');}}}
function openReceiptWindow(receipt){const receiptContent=`<div id="receiptContent" style="font-family:Arial;padding:20px;text-align:center;"><img src="./fci logo 1.png" style="max-width:100px;margin:0 auto;" alt="logo"/><h2 style="color:#006400;">First Class Senior High School</h2><p><strong>Academic Year:</strong> 2025/2026</p><p><strong>Contact:</strong> 0244406506 / 0245319301 / 0243686024 / 0242842244</p><p><strong>Website:</strong> www.firstclassschools.org</p><p><strong>Email:</strong> info@firstclassschools.org</p><hr style="border:none;height:2px;background:#006400;margin:15px 0;"/><hr style="border:none;height:2px;background:#ffd700;margin:15px 0;"/><p><strong>Branch:</strong> ${receipt.campus||'N/A'}</p><p><strong>Receipt No:</strong> ${receipt.receiptNumber||'N/A'}</p><p><strong>Name:</strong> ${receipt.studentName||'N/A'}</p><p><strong>Program:</strong> ${receipt.program||'N/A'}</p><p><strong>Payment Method:</strong> ${receipt.paymentMethod||'N/A'}</p><table border="1" style="width:100%;border-collapse:collapse;margin-top:15px;"><thead><tr><th>Description</th><th>Amount (GHS)</th></tr></thead><tbody><tr><td>Total Amount</td><td>${receipt.totalAmount||'0.00'}</td></tr><tr><td>Amount Paid</td><td>${receipt.amountPaid||'0.00'}</td></tr><tr><td><strong>Arrears</strong></td><td><strong>${receipt.arrears||'0.00'}</strong></td></tr></tbody></table><p><strong>Amount in Words:</strong> ${receipt.amountWords||'N/A'}</p><p><strong>Purpose of Payment:</strong> ${receipt.purposeList||'N/A'}</p><p><strong>Received By:</strong> ${receipt.receivedBy||'N/A'}</p><p><strong>Date:</strong> ${receipt.date||'N/A'}</p><hr style="border:none;height:2px;background:#ffd700;margin:15px 0;"/><p><strong>NOTE:</strong> Amount Paid are not refundable in any case whatsoever.</p><p style="color:#004b23;">Thank you for your payment. Keep this receipt for your records.</p><button onclick="window.print()" style="padding:8px 12px;margin:5px;background:#006400;color:#fff;border:none;border-radius:6px;cursor:pointer;">üñ®Ô∏è Print</button></div>`;const receiptWindow=window.open("","_blank","width=700,height=800");receiptWindow.document.open();receiptWindow.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>Receipt</title></head><body>${receiptContent}</body></html>`);receiptWindow.document.close();}
async function sendEmailWithPDF(pdfBlob,studentName){const reader=new FileReader();reader.readAsDataURL(pdfBlob);reader.onloadend=async function(){const dataUri=reader.result;const base64Only=dataUri.split(',')[1];const params={to_email:"info@firstclassschools.org",student_name:studentName,attachments:[{name:"receipt.pdf",data:base64Only}],message_base64:dataUri};try{await emailjs.send("service_u19zfiv","template_mgm00tm",params);alert("‚úÖ Email sent successfully!");}catch(error){console.error("EmailJS Error:",error);alert("‚ùå Failed to send email. Check console for details.");}};}

// Fixed PDF Preview Function
function previewPDF() {
    const studentName = document.getElementById("studentName").value || "N/A";
    const program = document.getElementById("class").value || "N/A";
    const campus = document.getElementById("campus").value || "N/A";
    const receiptNumber = document.getElementById("receiptNumber").value;
    const totalAmount = document.getElementById("totalAmount").value || "0.00";
    const amountPaid = document.getElementById("amountPaid").value || "0.00";
    const arrears = document.getElementById("arrears").value || "0.00";
    const paymentMethod = document.getElementById("paymentMethod").value || "N/A";
    const receivedBy = document.getElementById("receivedBy").value || "N/A";
    const date = document.getElementById("date").value || new Date().toLocaleDateString();
    const selectedPurposes = Array.from(document.getElementById("purposeOfPayment").selectedOptions).map(o => o.value);
    const purposeList = selectedPurposes.length > 0 ? selectedPurposes.join(", ") : "N/A";
    const amountWords = document.getElementById("amountInWords").innerText;

    // Create a temporary div for the receipt content
    const tempDiv = document.createElement('div');
    tempDiv.style.padding = '20px';
    tempDiv.style.fontFamily = 'Arial';
    tempDiv.style.textAlign = 'center';
    tempDiv.innerHTML = `
        <img src="./fci logo 1.png" style="max-width:100px;margin:0 auto;" alt="logo"/>
        <h2 style="color:#006400;">First Class Senior High School</h2>
        <p><strong>Academic Year:</strong> 2025/2026</p>
        <p><strong>Contact:</strong> 0244406506 / 0245319301 / 0243686024 / 0242842244</p>
        <p><strong>Website:</strong> www.firstclassschools.org</p>
        <p><strong>Email:</strong> info@firstclassschools.org</p>
        <hr style="border:none;height:2px;background:#006400;margin:15px 0;"/>
        <hr style="border:none;height:2px;background:#ffd700;margin:15px 0;"/>
        <p><strong>Branch:</strong> ${campus}</p>
        <p><strong>Receipt No:</strong> ${receiptNumber}</p>
        <p><strong>Name:</strong> ${studentName}</p>
        <p><strong>Program:</strong> ${program}</p>
        <p><strong>Payment Method:</strong> ${paymentMethod}</p>
        <table border="1" style="width:100%;border-collapse:collapse;margin-top:15px;">
            <thead><tr><th>Description</th><th>Amount (GHS)</th></tr></thead>
            <tbody>
                <tr><td>Total Amount</td><td>${totalAmount}</td></tr>
                <tr><td>Amount Paid</td><td>${amountPaid}</td></tr>
                <tr><td><strong>Arrears</strong></td><td><strong>${arrears}</strong></td></tr>
            </tbody>
        </table>
        <p><strong>Amount in Words:</strong> ${amountWords}</p>
        <p><strong>Purpose of Payment:</strong> ${purposeList}</p>
        <p><strong>Received By:</strong> ${receivedBy}</p>
        <p><strong>Date:</strong> ${date}</p>
        <hr style="border:none;height:2px;background:#ffd700;margin:15px 0;"/>
        <p><strong>NOTE:</strong> Amount Paid are not refundable in any case whatsoever.</p>
        <p style="color:#004b23;">Thank you for your payment. Keep this receipt for your records.</p>
        <p style="color:#ff0000; font-weight: bold;">PREVIEW - NOT SAVED TO DATABASE</p>
    `;

    // Append to body temporarily
    document.body.appendChild(tempDiv);

    // Use html2canvas to capture the content
    html2canvas(tempDiv, {
        scale: 2,
        useCORS: true,
        logging: false
    }).then(canvas => {
        // Remove temporary div
        document.body.removeChild(tempDiv);

        // Convert canvas to image
        const imgData = canvas.toDataURL('image/png');
        
        // Create PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgWidth = 190;
        const pageHeight = 295;
        const imgHeight = canvas.height * imgWidth / canvas.width;
        let heightLeft = imgHeight;
        let position = 10;

        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        // Add new pages if needed
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }

        // Open PDF in new window
        const pdfBlob = pdf.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        const previewWindow = window.open(pdfUrl, '_blank', 'width=800,height=600');
        
        if (!previewWindow) {
            alert('Popup blocked! Please allow popups for this site to view PDF preview.');
        }
    }).catch(error => {
        console.error('Error generating PDF preview:', error);
        alert('Error generating PDF preview. Please try again.');
        // Remove temporary div in case of error
        if (document.body.contains(tempDiv)) {
            document.body.removeChild(tempDiv);
        }
    });
}

async function generateReceipt(){const studentName=document.getElementById("studentName").value||"N/A";const program=document.getElementById("class").value||"N/A";const campus=document.getElementById("campus").value||"N/A";const receiptNumber=document.getElementById("receiptNumber").value;const totalAmount=document.getElementById("totalAmount").value||"0.00";const amountPaid=document.getElementById("amountPaid").value||"0.00";const arrears=document.getElementById("arrears").value||"0.00";const paymentMethod=document.getElementById("paymentMethod").value||"N/A";const receivedBy=document.getElementById("receivedBy").value||"N/A";const date=document.getElementById("date").value||new Date().toLocaleDateString();const selectedPurposes=Array.from(document.getElementById("purposeOfPayment").selectedOptions).map(o=>o.value);const purposeList=selectedPurposes.length>0?selectedPurposes.join(", "):"N/A";const amountWords=document.getElementById("amountInWords").innerText;if(!studentName||studentName==="N/A"){alert("Please enter student name");return;}if(!campus){alert("Please select a branch");return;}if(!amountPaid||parseFloat(amountPaid)<=0){alert("Please enter a valid amount paid");return;}const receiptData={studentName,program,campus,receiptNumber,totalAmount,amountPaid,arrears,paymentMethod,receivedBy,date,purposeList,amountWords};const saved=await saveReceiptToFirebase(receiptData);if(!saved){alert('Failed to save receipt to database. Please try again.');return;}const receiptContent=`<div id="receiptContent" style="font-family:Arial;padding:20px;text-align:center;"><img src="./fci logo 1.png" style="max-width:100px;margin:0 auto;" alt="logo"/><h2 style="color:#006400;">First Class Senior High School</h2><p><strong>Academic Year:</strong> 2025/2026</p><p><strong>Contact:</strong> 0244406506 / 0245319301 / 0243686024 / 0242842244</p><p><strong>Website:</strong> www.firstclassschools.org</p><p><strong>Email:</strong> info@firstclassschools.org</p><hr style="border:none;height:2px;background:#006400;margin:15px 0;"/><hr style="border:none;height:2px;background:#ffd700;margin:15px 0;"/><p><strong>Branch:</strong> ${campus}</p><p><strong>Receipt No:</strong> ${receiptNumber}</p><p><strong>Name:</strong> ${studentName}</p><p><strong>Program:</strong> ${program}</p><p><strong>Payment Method:</strong> ${paymentMethod}</p><table border="1" style="width:100%;border-collapse:collapse;margin-top:15px;"><thead><tr><th>Description</th><th>Amount (GHS)</th></tr></thead><tbody><tr><td>Total Amount</td><td>${totalAmount}</td></tr><tr><td>Amount Paid</td><td>${amountPaid}</td></tr><tr><td><strong>Arrears</strong></td><td><strong>${arrears}</strong></td></tr></tbody></table><p><strong>Amount in Words:</strong> ${amountWords}</p><p><strong>Purpose of Payment:</strong> ${purposeList}</p><p><strong>Received By:</strong> ${receivedBy}</p><p><strong>Date:</strong> ${date}</p><hr style="border:none;height:2px;background:#ffd700;margin:15px 0;"/><p><strong>NOTE:</strong> Amount Paid are not refundable in any case whatsoever.</p><p style="color:#004b23;">Thank you for your payment. Keep this receipt for your records.</p><button onclick="window.print()" style="padding:8px 12px;margin:5px;background:#006400;color:#fff;border:none;border-radius:6px;cursor:pointer;">üñ®Ô∏è Print</button><button id="emailBtn" style="padding:8px 12px;margin:5px;background:#006400;color:#fff;border:none;border-radius:6px;cursor:pointer;">üìß Send Email Receipt</button></div>`;const receiptWindow=window.open("","_blank","width=700,height=800");receiptWindow.document.open();receiptWindow.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>Receipt</title></head><body>${receiptContent}</body></html>`);receiptWindow.document.close();setTimeout(()=>{const emailBtn=receiptWindow.document.getElementById("emailBtn");if(!emailBtn)return;emailBtn.addEventListener("click",async()=>{const {jsPDF}=window.jspdf;const pdf=new jsPDF();const content=receiptWindow.document.getElementById("receiptContent");pdf.html(content,{callback:async(pdfDoc)=>{const pdfBlob=pdfDoc.output("blob");await sendEmailWithPDF(pdfBlob,studentName);},x:10,y:10,html2canvas:{scale:1}});});},400);generateReceiptNumber();document.getElementById("studentName").value="";document.getElementById("campus").value="";document.getElementById("class").value="";document.getElementById("paymentMethod").value="";document.getElementById("totalAmount").value="";document.getElementById("amountPaid").value="";document.getElementById("amountInWords").innerText="";document.getElementById("purposeOfPayment").selectedIndex=-1;document.getElementById("receivedBy").value="";document.getElementById("date").valueAsDate=new Date();document.getElementById("arrears").value="";}
applyFiltersBtn.addEventListener('click',()=>{currentFilters={search:searchInput.value,branch:filterBranch.value,dateFrom:filterDateFrom.value,dateTo:filterDateTo.value};currentPage=1;loadReceipts(currentFilters,currentPage);});
clearFiltersBtn.addEventListener('click',()=>{searchInput.value='';filterBranch.value='';filterDateFrom.value='';filterDateTo.value='';currentFilters={};currentPage=1;loadReceipts(currentFilters,currentPage);});
prevPageBtn.addEventListener('click',()=>{if(currentPage>1){currentPage--;displayReceipts(currentPage);}});
nextPageBtn.addEventListener('click',()=>{const totalPages=Math.ceil(filteredReceipts.length/receiptsPerPage);if(currentPage<totalPages){currentPage++;displayReceipts(currentPage);}});
generateReceiptBtn.addEventListener('click',generateReceipt);
previewBtn.addEventListener('click',previewPDF);
showLogin();
generateReceiptNumber();
</script>
</body>
</html>
